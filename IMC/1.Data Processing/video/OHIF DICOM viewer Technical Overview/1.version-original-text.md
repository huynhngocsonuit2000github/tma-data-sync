Dưới đây là bản dịch toàn bộ nội dung bản ghi chép (transcript) từ các nguồn bạn đã cung cấp để bạn nắm rõ bối cảnh (context) của buổi demo kỹ thuật này:
Phần 1: Giới thiệu về Project và Repository
Nhóm đã biết cách xử lý các lỗi "chia hết cho 3" và bạn biết rằng kho lưu trữ của tôi không thể hiển thị những hình ảnh đó trên trình xem (viewer). Chuyển sang cho anh. Vâng, hoàn hảo. Cảm ơn mọi người. Được rồi Patrick, trước khi bắt đầu, anh có mở rộng bảng điều khiển (panel) trên các video khi chúng ta tiến hành không? Có. Tuyệt. Cảm ơn. Còn gì nữa không?
Được rồi. Vậy máy chủ web "dot com" được dựa trên một dự án mã nguồn mở gọi là DICOM Cloud, ban đầu được triển khai cho bên chịu trách nhiệm. Và khi chúng tôi bắt đầu với dự án Maestro, có một vài điểm khác biệt. Về mặt kỹ thuật, có hai dịch vụ web Maestro DICOM và hai trình xem "dot com". Trình xem web DICOM retail dành cho cổng thông tin nhà tài trợ (sponsor portal). Sau đó, tôi đã tạo một repo tên là "Maestro dot com" cho Maestro.
Tôi chưa bao giờ có thể hợp nhất (merge) mọi thứ trở lại, nhưng... quay lại với Maestro. Nó đang chạy các phiên bản .NET mới nhất. Quên mất là chúng ta đã lên bản 7 hay chưa. Để xem nào. Khá tốt. Trong khi đó website "dot com" hoặc "sponsorportal.com" có lẽ đang chạy một phiên bản tương tự như vậy.
Không, tôi đoán là không phải, xin lỗi. Đó là những gì tôi đang nói đến. Chẳng phải nó trực quan sao? Có hai repo ở đây: "useful" và "responsible", và tất cả "maestro dot com" nằm trong repo "maestro dot com", trong đó có hai phiên bản của trình xem mà tôi sẽ nói chi tiết sau.
Phần 2: Cấu trúc Cơ sở dữ liệu (Database)
Bây giờ chúng ta sẽ xem xét cấu trúc cơ sở dữ liệu. Nó rất đơn giản và đây là bước đầu tiên khi ai đó nói "có lỗi với AA dot com". Trong môi trường dev và val, cơ sở dữ liệu DICOM thực tế nằm trong app server. Bản Production có máy chủ DB riêng gọi là "prod .com".
Thực sự chỉ có 4 bảng quan trọng. Cái này không quan trọng, cái kia cũng không. Nó ở đó vì đó là những gì họ có ban đầu và sau đó nó có một số thủ tục (procedures) cũng như mã code để truy xuất dữ liệu và các phương thức để chèn (insert) dữ liệu.
Để chèn hình ảnh, phương thức được gọi bởi Maestro Wind. Bệnh nhân không thực sự quan trọng với chúng tôi vì tất cả đều là loại dữ liệu ẩn danh (blinded). Chúng ta có ID bệnh nhân nhưng không có gì giúp ích ở đó cả. Điều quan trọng nhất là cài đặt máy chủ web "dot com". Đây là nơi có các mối quan hệ. Khi ai đó muốn xem một hình ảnh, nó sẽ là địa chỉ gốc của trình xem và sau đó luôn là dấu gạch chéo kèm phần cài đặt. Đó là mã định danh duy nhất (unique identifier). Cột Study ID ở đây là BTR ID, và ngày học (study date) thực chất là ngày quét (scan date). Đó là một phần của các thẻ (tags) "dot com".
Phần 3: Cấu trúc Dữ liệu DICOM và Lưu trữ S3
Trong một "study" (thực chất là một lần quét), có thể có nhiều "series". Nếu tôi tìm kiếm các hình ảnh cụ thể trong S3, tôi sẽ lấy "study key", đi đến "series" với khóa đó. "Series" cũng có định danh duy nhất, loại phương thức (modality) của series (như 123 chẳng hạn). Cuối cùng, tôi sẽ đi qua "object instance" với khóa series để tìm một bộ hình ảnh cụ thể.
Tôi đã tìm đường dẫn tệp (file path) này, đây là nơi nó tồn tại trong S3. Vì tôi đang xem ở môi trường dev, nó sẽ nằm trong thư mục "development BTPR", thư mục tải lên (submissions). Nó cung cấp cho bạn tên DICOM giống với tên tệp. Các thẻ DICOM nằm trong tệp nhưng được chèn vào cơ sở dữ liệu ở định dạng nhị phân để chúng ta không phải mở tệp khi trình xem yêu cầu thông tin, giúp trả về kết quả nhanh hơn.
Khi có vấn đề, tôi thường đi xuống mức này, lấy các tệp ra và thử xem trực tiếp. Có hai lỗi kiểm tra: đôi khi lỗi khi lấy dữ liệu từ DB (như lỗi 500 từ website), đôi khi lấy đúng nhưng trình xem không tương thích. Đầu tiên tôi sẽ kiểm tra log trên máy chủ web "dot com" để đảm bảo nó lấy tệp chính xác. Có các lệnh gọi Postman mà bạn có thể thực hiện để kiểm tra việc này. Trước đây từng có vấn đề với hai tệp lớn không tương thích.
Phần 4: API và Xác thực Người dùng (Authentication)
API máy chủ web DICOM thực sự chỉ có cấu trúc dữ liệu của các lệnh gọi (calls) để lấy study. Một điều mới được thực hiện trong năm qua là xác thực người dùng dựa trên quyền truy cập vào study. Nếu có quyền, hệ thống trả về dữ liệu.
Các study cũng có phương thức POST để tải lên (dành cho Jet). Có giới hạn 2GB, về lý thuyết có thể tăng lên nhưng chúng tôi chưa gặp vấn đề đó. Trình xem biểu tượng (icon viewer) gọi đến "frame controller" để lấy thông tin. Đôi khi người dùng nói không thấy hình ảnh, thường là do vấn đề phân quyền. Hệ thống sẽ lưu bộ nhớ đệm (cache) trong 10-15 phút nhưng sẽ gọi API xác thực của office.
Nếu là người dùng "all zero" (không có thông tin), hệ thống sẽ tìm người dùng theo email. Sau khi có thông tin, nó cần lấy toàn bộ thông tin study (lệnh gọi "stamp"). Nếu họ có quyền, chúng tôi sẽ truy cập dịch vụ study. Nếu không, chúng tôi cần kiểm tra quyền của người dùng đó trong ứng dụng DICOM.
Có hai loại người dùng: người dùng "all zero" hoặc người dùng đến từ Maestro (có cookie đi kèm).
Phần 5: Dịch vụ Lưu trữ và Xử lý Hình ảnh trên AWS
Tất cả những thứ cụ thể cho ETR nằm trong dự án AWS "bio research dot com". Các mục chính là dịch vụ lưu trữ (storage service) dẫn đến thông tin cơ sở dữ liệu. Có một phần được ghi chú (commented out) là khi chạy trong AWS với một vai trò (role) được thiết kế để cấp quyền truy cập. Nếu bạn debug tại địa phương (locally), bạn cần thiết lập AWS Explorer với một profile tương ứng.
Về vị trí AWS, đây là nơi thực tế lấy các tệp ra khỏi S3. Nó sẽ gọi "redicom", sao chép hình ảnh vào một luồng (stream), mở tệp và hiển thị trong trình xem "Ohif.com". Nó thiết lập cú pháp truyền tải (transfer syntax), trả về dữ liệu pixel chưa nén cho hình ảnh, duyệt qua từng khung hình (frame) và ghi vào luồng. Đôi khi yêu cầu bao gồm số thứ tự đào tạo (training number), nếu không nó sẽ duyệt qua tất cả các khung hình.
Đây chỉ là một phương thức hỗ trợ để sao chép dữ liệu từ bộ đệm (buffer) sang luồng. Chúng tôi từng gặp vấn đề nếu liên kết nội dung quá lớn gây lỗi, nhưng giờ chúng tôi chỉ kiểm tra phản hồi OK và đọc nó. Việc lấy tệp và đọc vào luồng thường không phải là vấn đề, vấn đề có thể nằm ở việc đảo ngược nó thành pixel chưa nén.
Đối với phần code khác, chúng ta có thể xác định vấn đề từ log. Đôi khi dữ liệu bị sửa đổi không tương thích. Code này hỗ trợ chuyển đổi sang định dạng khác. Ngoài ra còn có chức năng "đọc toàn bộ tệp" được tạo cho Jet để trả về tệp thô (raw file) tại S3.
Phần 6: Triển khai và Các phiên bản Trình xem (OHIF)
Code này được triển khai vào một cụm Hikas (Hikas cluster). Có hai dịch vụ cơ bản: Kaido (thiên về truy vấn - query) và Wado (thiên về hình ảnh thực tế). Hệ thống có nhiều lớp, cần đi sâu vào mới biết cụ thể thứ gì đang chạy ở đâu.
Lệnh SELECT được thực hiện để tìm kiếm hình ảnh liên quan đến study. Các phương thức tuân thủ tiêu chuẩn web DICOM ở một mức độ nhất định, nhưng không triển khai tất cả (ví dụ: không có chức năng xóa, chức năng cập nhật hoặc tải lên rất hạn chế) vì chúng tôi không sử dụng. Chúng tôi chủ yếu dùng để lấy hình ảnh ra và đưa dữ liệu vào hệ thống. Việc xử lý hình ảnh được thực hiện bởi Jet.
Về trình xem "dot com" (OHIF viewer): Nó dựa trên dự án mã nguồn mở OHIF. Phiên bản gốc là OHIF v2 (từ 26 tháng trước). Cách đây 3 tháng họ ra bản v3. Chúng tôi chưa chuyển sang v3 hoàn toàn vì một số chức năng của v2 chưa có trong v3. Tôi đã loại bỏ một số nút bấm khỏi bản mặc định.
Cả hai phiên bản đều có sẵn trong môi trường dev. Tôi chưa tạo tên nhóm ở các môi trường cao hơn nên dù code đã được triển khai, bạn vẫn chưa thể truy cập được vì không có endpoint.
Phần 7: Cấu hình và Xử lý lỗi
Phần quan trọng nhất của trình xem là các tệp cấu hình (config files). Đối với phiên bản 2, nó luôn sử dụng JS mặc định để xác thực. Một vấn đề khi hợp nhất (merging) là tệp này có cùng tên cho tất cả các môi trường, nên khi merge bạn phải luôn bỏ qua (skip) tệp này. Nếu bạn quên bỏ qua và ghi đè, hình ảnh sẽ không hiển thị vì nó trỏ sai instance.
Để build dự án, bạn cần cài đặt Yarn. Tôi sẽ gửi tài liệu hướng dẫn cách build. Quá trình này mất khoảng 5 phút.
Khi kiểm tra với người dùng bên ngoài, nếu gặp lỗi "Error loading image", có nghĩa là đã lấy được hình ảnh nhưng không thích nội dung trả về. Tôi sẽ kiểm tra Study Instance ID, Series Instance ID và Instance ID.
Một lỗi khác là tải lên cùng một Instance ID nhiều lần, điều này làm hỏng hệ thống. Ngoài ra, nếu không tải lên đúng cấp bậc (hierarchies), hệ thống cũng không hoạt động.
Phần 8: Bảo mật và Tổng kết
Trong các nghiên cứu về tim mạch (cardiac), mỗi thứ hiển thị là một "series". Một số tùy chọn như nút "tải xuống" sẽ bị loại bỏ.
Về việc debug, nếu muốn chạy local mà không cần cập nhật tệp cấu hình trỏ về localhost thì cần lưu ý. Hiện tại server chạy qua HTTP, có thể đổi sang HTTPS nhưng tôi chưa làm. Việc build tốn nhiều tài nguyên nên đã phải tăng tài nguyên hệ thống.
Để khắc phục sự cố, bạn có thể kiểm tra log DICOM hoặc dùng F12 (Inspect). Nếu có lỗ hổng bảo mật (như trong Java), cách tốt nhất là tải code mới nhất từ repo để vá lỗi.
Cuối cùng, dự án sử dụng YARN 1.17 và có tệp Docker đã được chỉnh sửa nhẹ. Phiên bản trình xem hiện tại là v2 (16). Còn dự án "harmony" mà mọi người từng làm trước đây hiện đã bị gác lại (shelved) và coi như đã "khai tử", đặc biệt là sau khi Jesse rời đi.
